html
	head
		link(rel='stylesheet' href='css/style.css')
		link(rel='stylesheet' href='https://fonts.googleapis.com/css?family=Unica+One')
		script(src="https://code.jquery.com/jquery-3.1.1.js"
		integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
		crossorigin="anonymous")
		script(src="https://code.highcharts.com/stock/highstock.js")
		script(src="https://code.highcharts.com/stock/modules/exporting.js")
		script(src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js')

	body
		div(id="container") 
			script.

			

				stock = '#{stock}'; 

				var seriesOptions = [],
				    seriesCounter = 0,
				    names = ['MSFT', 'AAPL', 'YHOO'];

				names.push(stock);

				/**
				 * Create the chart when all data is loaded
				 * @returns {undefined}
				 */
				function createChart() {

				    Highcharts.stockChart('container', {

				        rangeSelector: {
				            selected: 4
				        },

				        yAxis: {
				            labels: {
				                formatter: function () {
				                    return (this.value > 0 ? ' + ' : '') + this.value + '%';
				                }
				            },
				            plotLines: [{
				                value: 0,
				                width: 2,
				                color: 'silver'
				            }]
				        },

				        plotOptions: {
				            series: {
				                compare: 'percent',
				                showInNavigator: true
				            }
				        },

						title: {
							text: 'Waterloo Stock Exchange', 
							style: {
								'color': 'black'
							}
						}, 				        

				        tooltip: {
				            pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.change}%)<br/>',
				            valueDecimals: 2,
				            split: true
				        },

				        credits: {
							position: {
								align: 'left',
								verticalAlign: 'bottom',
								x: -300,
								y: -10
							}
						},

				        series: seriesOptions
				    });
				}

				$.each(names, function (i, name) {

				    // $.getJSON(`https://www.highcharts.com/samples/data/jsonp.php?filename=${name.toLowerCase()}-c.json&callback=?`,    function (data) {
				    $.getJSON(`https://www.quandl.com/api/v3/datasets/WIKI/${name.toLowerCase()}/data.json?api_key=6Wkrs1ujpP3GXWTVrSEk`,    function (data) {

				    	var rawDataPoints = data.dataset_data.data; 
						var dataPoints = rawDataPoints.map(function(value){
							var date = moment(moment(value[0], "YYYY-MM-DD").unix()*1000);
							return [date._i, value[4]]; 
						})

						dataPoints.sort(function(a,b){
						return a[0] - b[0];
						})
				        
				        seriesOptions[i] = {
				            name: name,
				            data: dataPoints
				        };

				        // As we're loading the data asynchronously, we don't know what order it will arrive. So
				        // we keep a counter and create the chart when all the data is loaded.
				        seriesCounter += 1;
				        if (seriesCounter === names.length) {
				            createChart();

				        }
				    });
				});			



		// Input container 
		div.input-container
			form(method="post", action="/stock")
				input(type='text', name='stock')
				button(type='submit') Go
			script. 
		div.stock-container

				

				

		



				